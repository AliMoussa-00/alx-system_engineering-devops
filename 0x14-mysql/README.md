# Implementing MySQL in our servers

## Install mysql 5.7.*

Paste the below `signature key` in the file: `signature.key`:

```bash
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: SKS 1.1.6
Comment: Hostname: pgp.mit.edu

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
sTSKHe+QnnnoFmu4gnmDU31i
=Xqbo
-----END PGP PUBLIC KEY BLOCK-----
```

Now that we have the signature in our file we can proceed with the installation

```
$ sudo apt-key add signature.key
$ sudo sh -c 'echo "deb http://repo.mysql.com/apt/ubuntu bionic mysql-5.7" >> /etc/apt/sources.list.d/mysql.list'

# to avoid an error to mysql server during update because the key is expired
# we need to recover it using
# !! the key id may be different so you might need to use
# sudo apt-get update to get the key
$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys B7B3B788A8D3785C

$ sudo apt-get update
$ sudo apt-cache policy mysql-server

$ sudo apt install -f mysql-client=5.7* mysql-community-server=5.7* mysql-server=5.7*
```

## Creating Users:

### Holberton user:

creating a user for the holberton school to be able to access  the replication status on both servers.

```sql
$ sudo mysql

(mysql)> CREATE USER 'holberton_user'@'localhost' IDENTIFIED BY 'projectcorrection280hbtn';

-- Grant to check the primary/replic or (master/slave) a status
(mysql)> GRANT REPLICATION CLIENT ON *.* TO 'holberton_user'@'localhost';

(mysql)> FLUSH PRIVILEGES;

(mysql)> SHOW GRANTS FOR 'holberton_user'@'localhost';
```
### Replica user
creating a new user for the replication
```sql
$ sudo mysql

CREATE USER 'replica_user'@'%' IDENTIFIED BY 'replica_password';
GRANT REPLICATION SLAVE ON *.* TO 'replica_user'@'%';
FLUSH PRIVILEGES;

-- Grant SELECT privileges on mysql.user to holberton_user
GRANT SELECT ON mysql.user TO 'holberton_user'@'localhost';
FLUSH PRIVILEGES;

```

## Creating DB in Web01

```sql
$ sudo mysql

create database tyrell_corp;
use tyrell_corp;
create table nexus6 (id INT autoincrement  PRIMARY KEY, name VARCHAR(50));
show tables;
INSERT INTO nexus6 values(1,'Leon');
select * from nexus6;

GRANT SELECT ON tyrell_corp.nexus6 TO 'holberton_user'@'localhost';

```

Replication

### 1- Adding the UFW rule

add a rule to ufw to allow incomming traffic to web-01 through port `3306`

```bash
# use your replica server IP (web-02 IP)
$ sudo ufw allow from 34.232.76.130 to any port 3306
```

### 2- Changin the Source DB conf

he default MySQL server configuration file is named `mysqld.cnf` and can be found in the `/etc/mysql/mysql.conf.d/` directory. Open this file **on the source server**

```bash
$ sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf

# --- /etc/mysql/mysql.conf.d/mysqld.cnf ---
. . .

server-id               = 1
log_bin                 = /var/log/mysql/mysql-bin.log  # This defines the base name and location of MySQL’s binary log file.
# bind-address  = 127.0.0.1

# replace include_database_name with the name of the database you want to replicate.
binlog_do_db          = tyrell_corp
. . .

$ sudo systemctl restart mysql
# OR
$ sudo service mysql restart

```

### 3- Retrieving Binary Log Coordinates from the Source

we need the binary log file name and position:

```sql
$ sudo mysql

-- stop the reading from the DB
FLUSH TABLES WITH READ LOCK;

-- get the current status
SHOW MASTER STATUS;

-- output !!
Output
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000001 |      154 | tyrell_corp  |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)

-- unlock the tables
UNLOCK TABLES;

```

### 5- Migrate if you already have data in Source

copying the data we have in our DB to the replica server DB

```bash
# in web-01
$ sudo mysqldump -u root tyrell_corp > tyrell_corp.sql

# EXIT to local
# then copy the 'tyrell_corp.sql' to locall
# copie from local to web-02
$ exit
$ scp web1:/home/ubuntu/tyrell_corp.sql .
$ scp tyrell_corp.sql web2:/tmp/

# Open web2
$ sudo mysql
(mysql)> create database tyrell_corp;
(mysql)> exit

$ sudo mysql tyrell_corp < /tmp/tyrell_corp.sql

```

### 6- Configuring the Replica Database

If you don't have data in the source to migrate just pass to this step

 change the replica’s configuration similar to how you changed the source’s.

```bash
$ sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf

# --- /etc/mysql/mysql.conf.d/mysqld.cnf ---
. . .

server-id               = 2
log_bin                 = /var/log/mysql/mysql-bin.log  # This defines the base name and location of MySQL’s binary log file.
# bind-address  = 127.0.0.1

# replace include_database_name with the name of the database you want to replicate.
binlog_do_db          = tyrell_corp
relay-log               = /var/log/mysql/mysql-relay-bin.log
. . .

$ sudo service mysql restart

```

### 7- Starting

now let's configure replica db

```sql
-- in web-02
$ sudo mysql

CHANGE MASTER TO
MASTER_HOST = '34.204.101.226', -- IP of
MASTER_USER = 'replica_user',
MASTER_PASSWORD = 'replica_password',
MASTER_LOG_FILE = 'mysql-bin.000001',
MASTER_LOG_POS = 154;

START SLAVE;

SHOW SLAVE STATUS\G; --The \G modifier in this command rearranges the text to make it more readable
```

### 8- Test

enter DB in source server add rows and check if it gets replicated in the replica DB

```sql
-- in web-01
$ sudo mysql

use tyrell_corp;
insert into nexus6 values(2, 'Heelo');

-- in web-02
use tyrell_corp;
select * from nexus6;
```
